---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getLangFromUrl, useTranslations } from '../i18n';
import { galleryImages, galleryCategories } from '../data/gallery';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const base = import.meta.env.BASE_URL;

// Prepend base URL to gallery images
const imagesWithBase = galleryImages.map(img => ({
  ...img,
  src: `${base}${img.src.replace(/^\//, '')}`,
  objectPosition: img.objectPosition || 'top'
}));
---

<BaseLayout
  title={`${t('gallery.title')} | ${t('site.title')}`}
  description={t('gallery.subtitle')}
  lang={lang}
>
  <!-- Hero Section -->
  <section class="relative py-20 bg-navy-600 overflow-hidden">
    <div class="absolute inset-0 opacity-20">
      <div class="absolute top-0 right-0 w-96 h-96 bg-gold-500 rounded-full blur-3xl"></div>
    </div>
    <div class="container-custom relative z-10">
      <div class="max-w-3xl">
        <span class="text-gold-400 font-semibold text-sm tracking-wider uppercase mb-4 block animate-fade-up">
          Visual Journey
        </span>
        <h1 class="text-white mb-6 animate-fade-up" style="animation-delay: 0.1s;">
          {t('gallery.title')}
        </h1>
        <p class="text-white/70 text-xl animate-fade-up" style="animation-delay: 0.2s;">
          {t('gallery.subtitle')}
        </p>
      </div>
    </div>
  </section>

  <!-- Gallery Section -->
  <section class="section-padding bg-white">
    <div class="container-custom">
      <!-- Filter Buttons -->
      <div class="flex flex-wrap justify-center gap-3 mb-12 animate-on-scroll">
        {galleryCategories.map((cat) => (
          <button
            class="gallery-filter px-6 py-3 rounded-full font-medium transition-all duration-300 data-[active=true]:bg-gold-500 data-[active=true]:text-white bg-gray-100 text-navy-600 hover:bg-gold-100"
            data-category={cat.id}
            data-active={cat.id === 'all'}
          >
            {t(cat.labelKey)}
          </button>
        ))}
      </div>

      <!-- Gallery Grid -->
      <div class="masonry-grid" id="gallery-grid">
        {imagesWithBase.map((image, index) => (
          <div
            class="gallery-item relative rounded-2xl overflow-hidden img-zoom cursor-pointer group"
            data-category={image.category}
            data-index={index}
          >
            <img
              src={image.src}
              alt={image.alt}
              class="w-full h-64 object-cover"
              style={`object-position: ${image.objectPosition}`}
              loading="lazy"
            />
            <!-- Overlay -->
            <div class="absolute inset-0 bg-gradient-to-t from-navy-900/80 via-navy-900/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-end p-4">
              <div>
                <span class="inline-block px-3 py-1 bg-gold-500/90 text-white text-xs font-medium rounded-full capitalize mb-2">
                  {image.category}
                </span>
                <p class="text-white text-sm">{image.alt}</p>
              </div>
            </div>
            <!-- Zoom Icon -->
            <div class="absolute top-4 right-4 w-10 h-10 bg-white/90 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
              <svg class="w-5 h-5 text-navy-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"/>
              </svg>
            </div>
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- Lightbox -->
  <div id="lightbox" class="fixed inset-0 z-50 hidden lightbox-overlay flex items-center justify-center p-4">
    <!-- Close Button -->
    <button id="lightbox-close" class="absolute top-4 right-4 text-white/80 hover:text-white p-2">
      <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </button>

    <!-- Navigation -->
    <button id="lightbox-prev" class="absolute left-4 text-white/80 hover:text-white p-2">
      <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
      </svg>
    </button>
    <button id="lightbox-next" class="absolute right-4 text-white/80 hover:text-white p-2">
      <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
      </svg>
    </button>

    <!-- Image Container -->
    <div class="max-w-5xl max-h-[90vh]">
      <img id="lightbox-image" src="" alt="" class="max-w-full max-h-[85vh] object-contain rounded-lg" />
      <p id="lightbox-caption" class="text-white text-center mt-4"></p>
    </div>

    <!-- Counter -->
    <div id="lightbox-counter" class="absolute bottom-4 left-1/2 -translate-x-1/2 text-white/60"></div>
  </div>
</BaseLayout>

<script define:vars={{ galleryImages: imagesWithBase }}>
  function initGallery() {
    const filterButtons = document.querySelectorAll('.gallery-filter');
    const galleryItems = document.querySelectorAll('.gallery-item');
    const lightbox = document.getElementById('lightbox');
    const lightboxImage = document.getElementById('lightbox-image');
    const lightboxCaption = document.getElementById('lightbox-caption');
    const lightboxCounter = document.getElementById('lightbox-counter');
    const closeBtn = document.getElementById('lightbox-close');
    const prevBtn = document.getElementById('lightbox-prev');
    const nextBtn = document.getElementById('lightbox-next');

    let currentIndex = 0;
    let visibleImages = [...galleryImages];

    // Filter functionality
    filterButtons.forEach((btn) => {
      btn.addEventListener('click', () => {
        const category = btn.dataset.category;

        // Update active state
        filterButtons.forEach((b) => b.dataset.active = 'false');
        btn.dataset.active = 'true';

        // Filter items
        galleryItems.forEach((item) => {
          const itemCategory = item.dataset.category;
          if (category === 'all' || itemCategory === category) {
            item.style.display = '';
            item.classList.remove('opacity-0', 'scale-95');
          } else {
            item.style.display = 'none';
          }
        });

        // Update visible images for lightbox
        if (category === 'all') {
          visibleImages = [...galleryImages];
        } else {
          visibleImages = galleryImages.filter((img) => img.category === category);
        }
      });
    });

    // Lightbox functionality
    function openLightbox(index) {
      currentIndex = index;
      updateLightbox();
      lightbox.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function closeLightbox() {
      lightbox.classList.add('hidden');
      document.body.style.overflow = '';
    }

    function updateLightbox() {
      const image = visibleImages[currentIndex];
      lightboxImage.src = image.src;
      lightboxImage.alt = image.alt;
      lightboxCaption.textContent = image.alt;
      lightboxCounter.textContent = `${currentIndex + 1} / ${visibleImages.length}`;
    }

    function nextImage() {
      currentIndex = (currentIndex + 1) % visibleImages.length;
      updateLightbox();
    }

    function prevImage() {
      currentIndex = (currentIndex - 1 + visibleImages.length) % visibleImages.length;
      updateLightbox();
    }

    // Event listeners
    galleryItems.forEach((item, index) => {
      item.addEventListener('click', () => {
        const category = document.querySelector('.gallery-filter[data-active="true"]').dataset.category;
        if (category === 'all') {
          openLightbox(index);
        } else {
          const visibleIndex = visibleImages.findIndex((img) => img.id === galleryImages[index].id);
          openLightbox(visibleIndex);
        }
      });
    });

    closeBtn?.addEventListener('click', closeLightbox);
    prevBtn?.addEventListener('click', prevImage);
    nextBtn?.addEventListener('click', nextImage);

    lightbox?.addEventListener('click', (e) => {
      if (e.target === lightbox) closeLightbox();
    });

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (lightbox?.classList.contains('hidden')) return;
      if (e.key === 'Escape') closeLightbox();
      if (e.key === 'ArrowRight') nextImage();
      if (e.key === 'ArrowLeft') prevImage();
    });
  }

  initGallery();
  document.addEventListener('astro:after-swap', initGallery);
</script>
